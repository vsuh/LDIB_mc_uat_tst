def cmdString // global variable
def ib = env.JOB_BASE_NAME

pipeline {
  options { timestamps() }
  agent { label 'obr-app-10' }
  stages {
    stage ( 'stage 1. Подготовка среды') {
      steps {
        script {
          echo '*** Инициализация среды и библиотек'
          load './lib/SetEnvironment.groovy'
          Common =  load './lib/Common.groovy'
          DB = load './lib/DBManage.groovy'
        }
      }
    }
    stage ('stage 2. Подготовка ИБ') {
      agent {
        label 'linux'
      }
        steps {
        script {
          echo '*** Инициализация среды и библиотек '
          myENV   = load './lib/SetEnvironment.groovy'
          Common  = load './lib/Common.groovy'
          DB      = load './lib/DBManage.groovy'
          CLADDR  = env.JN_tst_RAS_HOST
          CLPORT  = env.JN_tst_RAS_PORT

          echo '*** Блокирование ИБ "' + ib + '", отключение сеансов ' + Common.TimeNow()
          echo '+++++++++++++++++++++++++++++++++++ ' + Common.addMinutes(Common.TimeNow(), 5)
          echo '################################### ' + Common.formatDate(Common.addMinutes(Common.TimeNow(), 5))

          message = "Производится загрузка ИБ ${ib} из резервной копии"
          withCredentials([usernamePassword(credentialsId: 'ClusterAdmin', passwordVariable: 'clPASSWD', usernameVariable: 'clADMIN')
              ,usernamePassword(credentialsId: 'IBadmin', passwordVariable: 'ibPASSWORD', usernameVariable: 'ibADMIN')]) {
            clstID = DB.clusterIdentifierFromRAS(CLADDR, CLPORT, env.JN_tst_CLUSTER_1C_HOST)
            ibID = DB.databaseIdentifierFromRAS(CLADDR, CLPORT, clstID, ib, clADMIN, clPASSWD)
            DB.deleteConnectionsIBbyID(CLADDR, CLPORT, clstID, ibID, clADMIN, clPASSWD)
            DB.lockIBbyID(CLADDR, CLPORT, clstID, clADMIN, clPASSWD, ibID, ibADMIN, ibPASSWORD, message, "0008")
          }
        }
      }
    }

    stage( 'stage 3. формирование скрипта загрузки') {
      agent {
          label 'obr-app-10'
      }
      steps {script{
        echo '*** запуск `oscript make_sql_script.os`'
        Common.cmd('oscript')
      }}
    }
    stage( 'stage 1. загрузка бэкапа в ИБ') {
      steps {
        echo '*** выполнение скрипта `sqlcmd scriptname.sql` :::: ' + '"' + cmdString + '"'
      }
    }
  }
  post {
     always { script {
        echo '+++ снятие блокировки с ИБ'

          withCredentials([usernamePassword(credentialsId: 'ClusterAdmin', passwordVariable: 'clPASSWD', usernameVariable: 'clADMIN')
              ,usernamePassword(credentialsId: 'IBadmin', passwordVariable: 'ibPASSWORD', usernameVariable: 'ibADMIN')]) {
            bat('deployka')
          }
    }}
  }
}
